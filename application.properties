import { Component } from '@angular/core';
import { CombinedRegister } from '../models/combined-register.model';
import { AuthService, RegisterUser } from '../services/auth.service';
import { MemberService } from '../services/member.service';

@Component({
  selector: 'app-register',
  standalone: true,
  imports: [NavbarComponent, RouterLink, FormsModule],
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.css']
})
export class RegisterComponent {
  registerData: CombinedRegister = new CombinedRegister('', '', '', '', '', '', '');

  constructor(
    private authService: AuthService,
    private memberService: MemberService
  ) {}

  onRegister(): void {
    console.log('Registering user and member:', this.registerData);

    const userPayload = new RegisterUser(
      this.registerData.username,
      this.registerData.email,
      this.registerData.password,
      this.registerData.roles
    );

    this.authService.register(userPayload).subscribe(
      res => {
        console.log('✅ User registered:', res);

        const memberPayload = {
          name: this.registerData.name,
          email: this.registerData.email,
          phone: this.registerData.phone,
          address: this.registerData.address,
          membershipStatus: 'Active'
        };

        this.memberService.addMember(memberPayload).subscribe(
          () => alert('✅ User and Member Registered Successfully'),
          err => {
            console.error('❌ Member registration failed:', err);
            alert('⚠️ User registered, but Member registration failed');
          }
        );
      },
      err => {
        console.error('❌ User registration failed:', err);
        alert('❌ Failed to register user. Check username/email uniqueness or server status.');
      }
    );
  }
}
