import { Component } from '@angular/core';
import { NgForm } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService, RegisterUser } from '../auth.service';

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.css']
})
export class RegisterComponent {

  selectedRole: string = '';
  member = {
    name: '',
    email: '',
    phone: '',
    address: '',
    membershipStatus: 'Active'
  };

  constructor(private authService: AuthService, private router: Router) {}

  validateR(form: NgForm) {
    if (!this.selectedRole) {
      alert('Please select a role!');
      return;
    }

    const formData = form.value;

    const registerUser: RegisterUser = {
      username: formData.name,
      email: formData.email,
      password: formData.password,
      roles: this.selectedRole
    };

    // Register in auth
    this.authService.register(registerUser).subscribe({
      next: (response) => {
        console.log('Auth Registration Success:', response);

        if (this.selectedRole === 'member') {
          // Set member fields
          this.member.name = formData.name;
          this.member.email = formData.email;
          this.member.phone = formData.phone;
          this.member.address = formData.address;

          // Call addMember API
          this.authService.addMember(this.member).subscribe({
            next: (res) => {
              console.log('Member Added:', res);
              alert('Member Registered Successfully!');
              this.router.navigate(['/login']);
            },
            error: (err) => {
              console.error('Member Registration Failed:', err);
              alert('User created, but member registration failed!');
            }
          });
        } else {
          alert('Admin Registered Successfully!');
          this.router.navigate(['/login']);
        }
      },
      error: (err) => {
        console.error('Auth Registration Failed:', err);
        alert('Registration failed. Please try again.');
      }
    });
  }
}

<app-navbar></app-navbar>

<div class="container" style="margin-top: 100px;">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">Register</h3>
    </div>
    <div class="card-body">
      <form (ngSubmit)="validateR(registerForm)" #registerForm="ngForm" novalidate>

        <!-- Name -->
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input ngModel name="name" required type="text" class="form-control" />
        </div>

        <!-- Email -->
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input ngModel name="email" required type="email" class="form-control" />
        </div>

        <!-- Password -->
        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input ngModel name="password" required type="password" class="form-control" />
        </div>

        <!-- Phone -->
        <div class="mb-3">
          <label for="phone" class="form-label">Phone</label>
          <input ngModel name="phone" required type="text" class="form-control" />
        </div>

        <!-- Address -->
        <div class="mb-3">
          <label for="address" class="form-label">Address</label>
          <input ngModel name="address" required type="text" class="form-control" />
        </div>

        <!-- Role Dropdown -->
        <div class="mb-3">
          <label for="role" class="form-label">Select Role</label>
          <select ngModel name="role" required class="form-control" [(ngModel)]="selectedRole">
            <option value="" disabled selected>Select a role</option>
            <option value="member">Member</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <button class="btn btn-success w-100" type="submit" [disabled]="registerForm.invalid">
          Register
        </button>
      </form>
    </div>
  </div>
</div>
